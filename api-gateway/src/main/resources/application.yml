server:
  port: 8080 # El API Gateway se levanta en el puerto 8080

spring:
  application:
    name: api-gateway # Nombre l�gico del microservicio (como se ver� en Eureka)

## Seguridad en el Gateway (si validas JWT aqu�)
#spring:
#  security:
#    oauth2:
#      resourceserver:
#        jwt: # Config de validaci�n de JWT en el Gateway
#          # Opci�n A: usar jwk-set-uri de tu IdP (Keycloak, Auth0, Cognito, etc.)
#          jwk-set-uri: http://localhost:8081/realms/demo/protocol/openid-connect/certs
#          # Opci�n B (en lugar de jwk-set-uri): configurar issuer-uri si tu IdP lo soporta
#          # issuer-uri: http://localhost:8081/realms/demo

  cloud:
    gateway:
      default-filters: # Filtros aplicados a TODAS las rutas del Gateway
        - AddResponseHeader=X-Gateway, SpringCloudGateway # A�ade un header en cada respuesta
      globalcors: # Configuraci�n global de CORS (qu� or�genes pueden consumir la API)
        corsConfigurations:
          "[/**]": # Aplica a todas las rutas /**
            allowedOrigins: "*" # Permite cualquier origen
            allowedMethods: "*" # Permite cualquier metodo (GET, POST, PUT, DELETE?)
            allowedHeaders: "*" # Permite cualquier cabecera
            exposedHeaders: # Cabeceras que el navegador puede leer de la respuesta
              - Authorization
              - Location
            allowCredentials: false #No se permite enviar cookies o credenciales cross-site

      routes: # Definici�n de rutas en el Gateway
        # === Reenvía OAuth2 (inicio y callback) al auth-service ===
        - id: auth-oauth2
          uri: lb://auth-service
          predicates:
            - Path=/oauth2/**,/login/oauth2/**

        # === Reenvía login/refresh/logout (auth normal) y públicos del auth-service ===
        - id: auth-api
          uri: lb://auth-service
          predicates:
            - Path=/api/auth/**,/api/public/**,/api/reports/**,/api/user/**
            - Method=POST

        # === Ruta a PRODUCTOS-SERVICE ===
        - id: productos-route # Identificador interno de la ruta
          uri: lb://productos-service  # lb:// usa el Discovery Client (Eureka) + balanceo de carga
          predicates: # Condiciones que debe cumplir la request para redirigirse aqu�
            - Path=/productos/**         # Solo las rutas que empiecen con /productos/
            - Path=/api/productos/**
            - Method=GET,POST, DELETE            # Solo si el metodo es GET o POST
          filters: # Filtros aplicados a ESTA ruta
            - StripPrefix=0              # No elimina prefijos de la URL entrante/ no recorta prefijos (aj�stalo si usas /api/**)
            - AddRequestHeader=X-From, api-gateway # A�ade header a la request enviada al servicio
            # ejemplo de rewrite: /api/productos/** -> /productos/**
            # - RewritePath=/api/(?<segment>.*), /${segment}

        # === Ruta a PEDIDOS-SERVICE ===
        - id: pedidos-route
          uri: lb://pedidos-service
          predicates:
            - Path=/pedidos/**
            - Method=GET,POST, DELETE
          filters:
            - StripPrefix=0
            - AddRequestHeader=X-From, api-gateway


    # Si a�ades circuit breaker en el gateway, puedes activar un fallback (opcional):
    # gateway:
    #   routes:
    #     - id: productos-cb
    #       uri: lb://PRODUCTOS-SERVICE
    #       predicates:
    #         - Path=/safe-productos/** # Si falla esta ruta...
    #       filters:
    #         - name: CircuitBreaker # ...se aplica patr�n de circuit breaker
    #           args:
    #             name: productosCb
    #             fallbackUri: forward:/fallback/productos # Redirige al endpoint fallback

# El Gateway valida JWT con la CLAVE PÚBLICA (monta el mismo public.pem aquí)
  security:
    oauth2:
      resourceserver:
        jwt:
          public-key-location: file:${PUBLIC_KEY}   # ej: file:/keys/public.pem

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/ # URL del servidor Eureka
  instance:
    prefer-ip-address: true # Registra el microservicio con su IP, no con hostname

management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway # Expone v�a Actuator: health (salud), info, y estado del gateway
